defaults
    mode http
    timeout client 10s
    timeout connect 5s
    timeout server 10s
    timeout http-request 10s

frontend http-in
    bind *:80
    acl path_statics_path path /statics/path
    acl path_statics_path_beg path /statics/path/
    acl path_statics path /statics
    acl path_statics_beg path /statics/
    use_backend echoservers if { path_beg /api }
    use_backend nginxservers_path if path_statics_path || path_statics_path_beg
    use_backend nginxservers if path_statics || path_statics_beg

backend echoservers
    http-request replace-path /api(/)?(.*) /\2
    server echoserver1 echoserver:8080 check
    server echoserver2 echoserver:8080 check
    server echoserver3 echoserver:8080 check

backend nginxservers_path
    http-request replace-path ^/statics/path/(.*) /statics/\1 if { path_beg /statics/path }
    http-request replace-path ^/statics/path$ /statics/ if { path /statics/path }
    # stick-table type string len 100 size 10k expire 1h
    cookie SERVER_USED insert indirect nocache
    server nginx1 nginx:80 check
    server nginx2 nginx:80 check
    server nginx3 nginx:80 check

backend nginxservers
    http-request replace-path /statics(/)?(.*) /\2
    server nginx1 nginx:80 check
    server nginx2 nginx:80 check
    server nginx3 nginx:80 check
